<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBD Legion Bot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="/js/vue.js"></script>
    <script src="/js/axios.js"></script>
    <link rel="stylesheet" href="/css/index.css">
</head>
<body>
<div id="app">
    <!-- Blurred gameplay background -->
    <div class="video-background">
        <video autoplay muted loop>
            <source src="/video/gameplay.mp4" type="video/mp4">
        </video>
    </div>

    <!-- Header with login -->
    <header>
        <div class="logo">
            DBD <span>Legion</span>Bot
        </div>
        <button class="login-btn" @click="loginWithTwitch" v-if="!user">
            Login with Twitch
        </button>
        <div v-else class="user-info">
            <img :src="user.profile_image_url" class="user-avatar" width="32" height="32" style="border-radius: 50%;">
            <span>{{ user.display_name }}</span>
        </div>
    </header>

    <!-- Hero section -->
    <section class="hero">
        <h1>Elevate Your Twitch Chat Experience</h1>
        <p>Legion Bot brings powerful moderation, engagement tools, and custom commands to your stream. Keep your chat clean and interactive with our advanced AI-powered bot.</p>
        <div class="cta-buttons">
            <button class="primary-btn" @click="loginWithTwitch">Get Started</button>
            <button class="secondary-btn">Learn More</button>
        </div>
    </section>

    <!-- Features section -->
    <section class="features">
        <h2 class="section-title">Powerful Features</h2>
        <div class="feature-grid">
            <div class="feature-card scroll-animate" :class="{visible: featuresVisible[0]}" ref="feature1">
                <div class="feature-icon">ü§ñ</div>
                <h3 class="feature-title">AI Moderation</h3>
                <p class="feature-desc">Our advanced AI detects and filters toxic behavior, spam, and inappropriate content before it reaches your chat.</p>
            </div>

            <div class="feature-card scroll-animate" :class="{visible: featuresVisible[1]}" ref="feature2">
                <div class="feature-icon">üéÆ</div>
                <h3 class="feature-title">Game Integration</h3>
                <p class="feature-desc">Interactive commands that connect with popular games, showing stats, leaderboards, and in-game events.</p>
            </div>

            <div class="feature-card scroll-animate" :class="{visible: featuresVisible[2]}" ref="feature3">
                <div class="feature-icon">‚ú®</div>
                <h3 class="feature-title">Custom Commands</h3>
                <p class="feature-desc">Create unlimited custom commands with variables, cooldowns, and permissions to engage your viewers.</p>
            </div>

            <div class="feature-card scroll-animate" :class="{visible: featuresVisible[3]}" ref="feature4">
                <div class="feature-icon">üìä</div>
                <h3 class="feature-title">Analytics Dashboard</h3>
                <p class="feature-desc">Detailed chat analytics to understand viewer engagement, peak activity times, and most active chatters.</p>
            </div>

            <div class="feature-card scroll-animate" :class="{visible: featuresVisible[4]}" ref="feature5">
                <div class="feature-icon">ü§ù</div>
                <h3 class="feature-title">Community Points</h3>
                <p class="feature-desc">Reward loyal viewers with a customizable points system they can redeem for channel rewards.</p>
            </div>

            <div class="feature-card scroll-animate" :class="{visible: featuresVisible[5]}" ref="feature6">
                <div class="feature-icon">üîî</div>
                <h3 class="feature-title">Notifications</h3>
                <p class="feature-desc">Get alerts for new followers, subscribers, raids, and other important channel events.</p>
            </div>
        </div>
    </section>

    <footer>
        <div class="footer-links">
            <a href="#" class="footer-link">Documentation</a>
            <a href="#" class="footer-link">Support</a>
            <a href="#" class="footer-link">Privacy Policy</a>
            <a href="#" class="footer-link">Terms of Service</a>
        </div>
        <p class="copyright">¬© 2024-2025 DBD Legion Bot</p>
    </footer>
</div>

<script>
  const { createApp, ref, onMounted, onUnmounted } = Vue;

  createApp({
    setup() {
      // Reactive state
      const user = ref(null);
      const featuresVisible = ref(Array(6).fill(false));
      const isLoading = ref(false);

      // Methods
      const loginWithTwitch = async () => {
        isLoading.value = true;
        try {
          const response = await axios.get('/api/auth/login');
          if (response.data?.authUrl) {
            localStorage.setItem('twitch_auth_state', response.data.state);
            window.location.href = response.data.authUrl;
          }
        } catch (error) {
          console.error('Error during Twitch login:', error);
          // Consider adding user feedback here
        } finally {
          isLoading.value = false;
        }
      };

      const validateToken = async () => {
        try {
          const token = localStorage.getItem('legionbot_token');
          if (!token) return;

          const response = await axios.get('/api/validate', {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (response.data) {
            user.value = response.data;
          }
        } catch (error) {
          console.error('Token validation failed:', error);
          // Clear invalid token
          localStorage.removeItem('legionbot_token');
        }
      };

      const handleScroll = () => {
        const featureElements = document.querySelectorAll('.feature-card');
        featureElements.forEach((el, index) => {
          if (el) {
            const rect = el.getBoundingClientRect();
            featuresVisible.value[index] = rect.top < window.innerHeight - 100;
          }
        });
      };

      // Lifecycle hooks
      onMounted(() => {
        // Handle OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const state = urlParams.get('state');

        if (token && state) {
          const storedState = localStorage.getItem('twitch_auth_state');
          if (state === storedState) {
            localStorage.setItem('legionbot_token', token);
            localStorage.removeItem('twitch_auth_state');
            window.history.replaceState({}, '', window.location.pathname);
          } else {
            console.error('State mismatch - possible CSRF attack');
          }
        }

        // Always validate token (new or existing)
        validateToken();

        // Scroll handling
        window.addEventListener('scroll', handleScroll, { passive: true });
        handleScroll(); // Initial check
      });

      // Cleanup
      onUnmounted(() => {
        window.removeEventListener('scroll', handleScroll);
      });

      return {
        user,
        isLoading,
        featuresVisible,
        loginWithTwitch
      };
    }
  }).mount('#app');
</script>
</body>
</html>
